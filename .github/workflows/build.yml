name: build

on:
  push:
  pull_request:

defaults:
  run:
    shell: bash

env:
  BUILD_TYPE: Release
  LIBTORCH_URL: https://download.pytorch.org/libtorch/cu126/libtorch-cxx11-abi-shared-with-deps-2.7.0%2Bcu126.zip
  TORCH_DIR: ${{ github.workspace }}/_deps/libtorch

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: nvidia/cuda:12.6.0-devel-ubuntu24.04

    steps:
      - name: Install tools needed for checkout
        run: |
          apt-get update
          apt-get install -y --no-install-recommends git ca-certificates

      - uses: actions/checkout@v4
        with:
          submodules: recursive   # fetch RAMA submodule here

      - name: Mark repo as safe for git (container mount)
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install build deps
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            build-essential cmake ninja-build pkg-config \
            git curl unzip ca-certificates \
            python3 python3-dev python3-venv \
            libopencv-dev libopencv-contrib-dev

      - name: Cache LibTorch
        id: cache-libtorch
        uses: actions/cache@v4
        with:
          path: _deps/libtorch
          key: ${{ runner.os }}-libtorch-${{ env.LIBTORCH_URL }}

      - name: Download LibTorch
        if: steps.cache-libtorch.outputs.cache-hit != 'true'
        run: |
          mkdir -p _deps
          cd _deps
          curl -L "$LIBTORCH_URL" -o libtorch.zip
          unzip -q libtorch.zip
          rm -f libtorch.zip

      - name: Setup repo (submodule + patches + configure)
        run: |
          chmod +x ./setup.sh
          ./setup.sh -GNinja -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -DENABLE_CUDA=ON -DPython_EXECUTABLE=/usr/bin/python3

      - name: Build
        run: cmake --build build -j 2
